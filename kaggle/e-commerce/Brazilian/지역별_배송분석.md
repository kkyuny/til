## 지역별 배송 분석
### 1. 지역별 셀러 1명 당 고객수 확인
``` sql
WITH customer_cnt AS
(
SELECT  customer_state
		,COUNT(DISTINCT customer_unique_id) AS customer_cnt
  FROM  olist_customers_dataset
 GROUP
    BY  1
),
seller_cnt AS
(
SELECT  seller_state
        ,COUNT(DISTINCT seller_id) AS seller_cnt
  FROM  olist_sellers_dataset
 GROUP
    BY  1
)
SELECT  c.customer_state
		,customer_cnt
        ,seller_cnt
        ,customer_cnt / seller_cnt AS number_customers_per_seller
  FROM  customer_cnt AS c 
  LEFT
  JOIN  seller_cnt AS s
    ON  c.customer_state = s.seller_state
 ORDER
    BY  4 DESC;
```
- 지역별 customer와 seller를 집계 후 join해야 정확한 계산이 가능하다.
- 실행결과
  - 셀러 한명당 고객수가 높은 지역: 'PA', 'MA', 'PI', 'MT', 'PE'
  - 셀러가 없는 지역: 'AL', 'AP', 'RR', 'TO'
  - 셀러 당 고객수가 높은 지역과 셀러가 없는 지역은 모두 customer가 많지 않다는 특징이 있다.

### 2. 지역별 배송기간 확인
``` sql
WITH DELIVERY_BY_customer_state AS
(
SELECT  c.customer_state
		,o.order_id
		,DATEDIFF(order_delivered_customer_date, order_purchase_timestamp) as arrived_day
  FROM  olist_orders_dataset AS o
  INNER 
  JOIN  olist_order_items_dataset AS oi 
    ON  o.order_id = oi.order_id
  LEFT 
  JOIN  olist_customers_dataset AS c 
    ON  c.customer_id = o.customer_id
),
AVG_arrived_day_by_customer_state AS (
SELECT  customer_state
        ,COUNT(DISTINCT order_id) AS ORDER_NO_CNT
		,AVG(arrived_day) AS AVG_arrived_day
  FROM  DELIVERY_BY_customer_state
 WHERE  arrived_day IS NOT NULL
 GROUP
    BY  1
)
SELECT  *
		,CASE WHEN customer_state IN ('PA', 'MA', 'PI', 'MT', 'PE') THEN 'Y' ELSE 'N' END AS SEG_YN
  FROM  AVG_arrived_day_by_customer_state
 ORDER
    BY  3 DESC;
```
- 실행결과
  - 주문수가 낮은 지역의 배송기간은 길고 주문수가 많은 지역일수록 배송기간이 짧아지는 특징이 있다.

### 3. 지역별 배송기간 테이블 생성
``` sql
CREATE TABLE DELIVERY_BY_STATE AS (
SELECT  o.order_id
		,order_purchase_timestamp
		,DATEDIFF(order_delivered_customer_date, order_purchase_timestamp) as arrived_day
		,oi.order_item_id
        ,customer_unique_id
        ,c.customer_state
        ,CASE WHEN c.customer_state IN ('PA', 'MA', 'PI', 'MT', 'PE') THEN 'Y' ELSE 'N' END SEG_YN
		,seller_id
        ,price
        ,freight_value
        ,p.product_weight_g
        ,pct.product_category_name
  FROM  olist_orders_dataset AS o
  INNER 
  JOIN  olist_order_items_dataset AS oi 
    ON  o.order_id = oi.order_id
  LEFT 
  JOIN  olist_customers_dataset AS c 
    ON  c.customer_id = o.customer_id
  LEFT 
  JOIN  olist_products_dataset AS p 
    ON  oi.product_id = p.product_id
  LEFT 
  JOIN  product_category_name_translation AS pct 
    ON  p.product_category_name = pct.product_category_name
);
```

### 4. 월별 배송 기간 확인
``` sql
SELECT  DATE_FORMAT(order_purchase_timestamp, '%Y-%m') AS YM
		,AVG(arrived_day) AS AVG_arrived_day
        ,COUNT(DISTINCT order_id) AS ORDER_NO_CNT
  FROM  DELIVERY_BY_STATE
 WHERE  arrived_day IS NOT NULL
   AND  customer_state NOT IN ('SP', 'MG', 'RJ') 
 GROUP
    BY  1
 ORDER
    BY  1;
```
- DATE_FORMAT('%Y-%d')를 이용하여 월별 배송일자를 집계한다.
- 실행결과
  - 2018-04부터 평균 배송일자가 감소하였다.

### 5. 배송기간이 줄어든 원인 확인하기
``` sql
SELECT  DATE_FORMAT(order_purchase_timestamp, '%Y-%m') AS YM
		,AVG(arrived_day) AS AVG_arrived_day
        ,COUNT(DISTINCT order_id) AS ORDER_NO_CNT
  FROM  DELIVERY_BY_STATE
 WHERE  arrived_day IS NOT NULL
   AND  SEG_YN = 'Y'
 GROUP
    BY  1
 ORDER
    BY  1;
```
- 실행결과
  - SEG_YN = 'Y'인 지역과 전체지역의 배송기간에는 큰 차이가 없다.
  - 배송기간이 줄어든 원인을 확인하기 위하여 SEG_YN을 이용하여 확인해보았지만 원인 확인이 어렵다.

### 지역별 배송 분석 결론   
1. 셀러 한명당 고객수가 높은 지역('PA', 'MA', 'PI', 'MT', 'PE') / 셀러가 없는지역('AL', 'AP', 'RR', 'TO')
2. 평균 배송 시간이 2018.04부터 급격히 줄어든 원인은 데이터 상으로 확인하기 어렵고, 배송 프로세스 개선이 이뤄진 것으로 예상된다.  
