## 상품 구매주기 분석
### 1. 카테고리별 구매주기 테이블 생성
``` sql
CREATE TABLE ORDER_INFO_BY_CATEGORY AS (
SELECT  pct.product_category_name
		,MIN(order_purchase_timestamp) AS MIN_order_purchase_timestamp
        ,MAX(order_purchase_timestamp) AS MAX_order_purchase_timestamp
		,COUNT(DISTINCT o.order_id) AS COUNT_DISTINCT_ORDER_NO
  FROM  olist_orders_dataset AS o
  INNER 
  JOIN  olist_order_items_dataset AS oi 
    ON  o.order_id = oi.order_id
  LEFT 
  JOIN  olist_products_dataset AS p 
    ON  oi.product_id = p.product_id
  LEFT 
  JOIN  product_category_name_translation AS pct 
    ON  p.product_category_name = pct.product_category_name
 WHERE  pct.product_category_name IS NOT NULL
 GROUP
    BY  1
);
```

``` sql
CREATE TABLE ORDER_INFO_BY_CATEGORY_CIRCLE AS ( 
WITH CIRCLE AS (
SELECT  *
		,DATEDIFF(MAX_order_purchase_timestamp, MIN_order_purchase_timestamp) AS DIFF_MIN_MAX_ORDER_DATE
        ,COUNT_DISTINCT_ORDER_NO - 1 AS COUNT_DISTINCT_ORDER_NO_1
        ,DATEDIFF(MAX_order_purchase_timestamp, MIN_order_purchase_timestamp) / (COUNT_DISTINCT_ORDER_NO - 1) AS CIRCLE
  FROM  ORDER_INFO_BY_CATEGORY
 WHERE  COUNT_DISTINCT_ORDER_NO > 1
)
SELECT  product_category_name
		,CIRCLE
        ,COUNT_DISTINCT_ORDER_NO
  FROM  CIRCLE
);
```
- 카테고리별 그룹바이를 진행한다.
- 해당 카테고리별 최초구매일자, 최종구매일자, 주문건수를 집계한다.
- 카테고리별 구매주기를 (최종구매일자-최초구매일자)/주문건수로 계산할 수 있다.
- ex) (최종구매(2025.04.30)-최초구매(2025.01.01))/주문건수(10건) => 4개월간 10건 구매로 구매주기(12일)를 얻을 수 있다.

### 2. 카테고리별 매출 기여도 확인
``` sql
WITH BASE AS (
SELECT  pct.product_category_name
		,SUM(IFNULL(oi.price,0)) + SUM(IFNULL(oi.freight_value,0)) AS sale_amt
  FROM  olist_orders_dataset AS o
  INNER 
  JOIN  olist_order_items_dataset AS oi 
    ON  o.order_id = oi.order_id
  LEFT 
  JOIN  olist_products_dataset AS p 
    ON  oi.product_id = p.product_id
  LEFT 
  JOIN  product_category_name_translation AS pct 
    ON  p.product_category_name = pct.product_category_name
 WHERE  pct.product_category_name IS NOT NULL
 GROUP
    BY  1
)
SELECT  BASE.*
		,CIRCLE
    ,COUNT_DISTINCT_ORDER_NO
  FROM  BASE AS BASE
  LEFT
  JOIN  ORDER_INFO_BY_CATEGORY_CIRCLE AS CIRCLE
    ON  BASE.product_category_name = CIRCLE.product_category_name
 ORDER
    BY  sale_amt DESC;
```
- 카테고리별 이름으로 group by 후 상품구매 금액의 합계를 집계한다.
- 생성한 구매주기 테이블과 join하여 카테고리별 매출을 확인할 수 있다.

### 3. 고객별 구매주기 테이블 생성
``` sql
CREATE TABLE ORDER_INFO_BY_CUSTOMER AS (
SELECT  c.customer_unique_id
		,MIN(order_purchase_timestamp) AS MIN_order_purchase_timestamp
        ,MAX(order_purchase_timestamp) AS MAX_order_purchase_timestamp
		,COUNT(DISTINCT o.order_id) AS COUNT_DISTINCT_ORDER_NO
		-- ,COUNT(DISTINCT DATE(o.order_purchase_timestamp)) AS COUNT_DISTINCT_ORDER_DAY
  FROM  olist_orders_dataset AS o
  INNER 
  JOIN  olist_order_items_dataset AS oi 
    ON  o.order_id = oi.order_id
  LEFT 
  JOIN  olist_products_dataset AS p 
    ON  oi.product_id = p.product_id
  LEFT 
  JOIN  product_category_name_translation AS pct 
    ON  p.product_category_name = pct.product_category_name
  LEFT
  JOIN  olist_customers_dataset AS c
    ON  o.customer_id = c.customer_id
 -- WHERE  pct.product_category_name IS NOT NULL
 GROUP
    BY  1
);
```

``` sql
CREATE TABLE ORDER_INFO_BY_CUSTOMER_CIRCLE AS ( 
WITH CIRCLE AS (
SELECT  *
		,DATEDIFF(MAX_order_purchase_timestamp, MIN_order_purchase_timestamp) AS DIFF_MIN_MAX_ORDER_DATE
		,COUNT_DISTINCT_ORDER_NO - 1 AS COUNT_DISTINCT_ORDER_NO_1
		-- ,COUNT_DISTINCT_ORDER_DAY - 1 AS COUNT_DISTINCT_ORDER_DAY_1
        ,DATEDIFF(MAX_order_purchase_timestamp, MIN_order_purchase_timestamp) / (COUNT_DISTINCT_ORDER_NO - 1) AS CIRCLE
		-- ,DATEDIFF(MAX_order_purchase_timestamp, MIN_order_purchase_timestamp) / (COUNT_DISTINCT_ORDER_DAY - 1) AS CIRCLE
  FROM  ORDER_INFO_BY_CUSTOMER
 WHERE  1=1
   AND  COUNT_DISTINCT_ORDER_NO > 1
   -- AND  COUNT_DISTINCT_ORDER_DAY > 1 
)
SELECT  customer_unique_id
		,CIRCLE
		,COUNT_DISTINCT_ORDER_NO_1
		-- ,COUNT_DISTINCT_ORDER_DAY
  FROM  CIRCLE
);
```
- 구매 정보를 구한 뒤 customer_unique_id로 group by하여 고객별 구매주기를 확인할 수 있다.

### 구매주기 분석 결과
1. 카테고리별로 구매주기 편차가 크다는 사실을 확인하였다.
2. 구매 횟수가 2번 이상인 회원이 드물게 있음을 확인하였다.
3. 회원별 구매주기는 평균 80일이므로, 첫 상품을 구매 한지 80일 정도 지난 회원들에게 매출을 만들 수 있는 마케팅 활동을 제안한다.
